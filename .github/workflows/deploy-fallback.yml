name: ğŸš€ Build Only (Manual Deploy)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ğŸ” Auto detect package manager
      - name: Detect Package Manager
        id: detect-pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi
          echo "Detected package manager: ${{ steps.detect-pm.outputs.manager }}"

      # âš™ï¸ Setup pnpm if needed
      - name: Setup pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # ğŸ“¦ Install dependencies
      - name: Install Dependencies
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      # ğŸ—ï¸ Build Next.js + Payload
      - name: Build Next.js + Payload
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      # ğŸ—‚ï¸ Optimize and prepare files for manual upload
      - name: Prepare Files for Manual Upload
        run: |
          echo "ğŸ—‚ï¸ Optimizing files for manual upload..."

          # Create deployment folders
          mkdir -p DEPLOY_STANDALONE
          mkdir -p DEPLOY_STATIC
          mkdir -p DEPLOY_PUBLIC

          # Copy optimized standalone files
          cp -r .next/standalone/* DEPLOY_STANDALONE/

          # Copy static files
          cp -r .next/static/* DEPLOY_STATIC/

          # Copy public files (only essential ones)
          cp public/*.{ico,svg,png,jpg,jpeg,gif,webp} DEPLOY_PUBLIC/ 2>/dev/null || true

          # Copy .htaccess
          cp .htaccess DEPLOY_PUBLIC/

          # Remove unnecessary files
          find DEPLOY_STANDALONE -name "*.md" -delete
          find DEPLOY_STANDALONE -name "*.txt" -delete
          find DEPLOY_STANDALONE -name "*.log" -delete
          find DEPLOY_STANDALONE -name "README*" -delete
          find DEPLOY_STANDALONE -name ".git*" -delete
          find DEPLOY_STANDALONE -name "*.test.*" -delete
          find DEPLOY_STANDALONE -name "*.spec.*" -delete
          rm -rf DEPLOY_STANDALONE/tests 2>/dev/null || true
          rm -rf DEPLOY_STANDALONE/.git 2>/dev/null || true

          echo "âœ… Build optimization complete!"
          echo "ğŸ“ Ready for manual upload via FileZilla"

      - name: âœ… Build Complete
        run: echo "âœ… Build selesai! Folder siap diupload manual via FileZilla"
