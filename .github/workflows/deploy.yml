name: üöÄ Deploy Payload + Next.js Hybrid to CPanel (via Neon DB)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js environment
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3Ô∏è‚É£ Install dependencies
      - name: üì¶ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # 4Ô∏è‚É£ Build using temporary Neon DB (to bypass cPanel DB limit)
      - name: üèóÔ∏è Build Next.js + Payload CMS
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          NEXT_PUBLIC_SERVER_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          NEXT_PUBLIC_PAYLOAD_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}/api
          NODE_ENV: production
        run: |
          echo "üöß Building project using temporary Neon database..."
          npm run build -- --no-lint
          echo "‚úÖ Build completed successfully."

      # 5Ô∏è‚É£ (Optional) Export static output if you use `next export`
      # Uncomment if you use static export:
      # - name: üß± Export static build
      #   run: npm run export

      # 6Ô∏è‚É£ Prepare deployment package
      - name: üì¶ Prepare deployment package
        run: |
          echo "üß≥ Preparing deployment package..."
          mkdir -p deploy
          cp -r .next public package.json package-lock.json server.js deploy/
          echo "‚úÖ Deployment package ready."

      # 7Ô∏è‚É£ Deploy build to Dewaweb (cPanel) via FTP
      - name: üì§ Deploy to Dewaweb via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: ./deploy
          server-dir: /cms.bungmekanik.co.id/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/payload-types.ts

      # 8Ô∏è‚É£ Done notification
      - name: ‚úÖ Deployment finished
        run: echo "‚úÖ Upload completed. Please restart Node.js app manually in your Dewaweb cPanel."
