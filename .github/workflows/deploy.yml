name: ğŸš€ Deploy Payload + Next.js Hybrid (Auto Detect Package Manager)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ğŸ§° Auto detect package manager
      - name: ğŸ” Detect Package Manager
        id: detect-pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi
          echo "Detected package manager: ${{ steps.detect-pm.outputs.manager }}"

      # ğŸ§° Setup PNPM if used
      - name: âš™ï¸ Setup pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # ğŸ“¦ Install dependencies
      - name: ğŸ“¦ Install Dependencies
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
          fi

      # ğŸ§± Run Payload DB migration (fix missing tables)
      - name: ğŸ§± Run Payload DB migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm payload migrate
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn payload migrate
          else
            npx payload migrate
          fi

      # ğŸ—ï¸ Build Next.js + Payload CMS
      - name: ğŸ—ï¸ Build Next.js + Payload CMS
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      # ğŸ§³ Prepare deployment package
      - name: ğŸ§³ Prepare deployment package
        run: |
          zip -r build.zip . -x "*.git*" "node_modules/*" ".github/*"

      # ğŸ“¤ Upload to cPanel via FTP
      - name: ğŸ“¤ Upload to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: .
          server-dir: /cms.bungmekanik.co.id/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/payload-types.ts
            **/build.zip

      - name: ğŸ”„ Done
        run: echo "âœ… Build, migrate, and upload complete. Restart Node.js app manually in cPanel."
