name: ğŸš€ Deploy Next.js to cPanel via SSH

on:
push:
branches: - main

jobs:
deploy:
runs-on: ubuntu-latest

  steps:
    - name: ğŸ§­ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build Next.js App
      run: npm run build

    - name: ğŸ“‚ Prepare build-output folder
      run: |
        mkdir -p build-output
        cp -r .next package.json package-lock.json next.config.* tsconfig.* public/ build-output/ 2>/dev/null || true
        echo "ğŸ“ Build output content:"
        ls -la build-output

    - name: ğŸ—œï¸ Compress build-output
      run: |
        cd build-output
        tar -czf ../build-output.tar.gz .
        cd ..
        echo "âœ… build-output.tar.gz created:"
        ls -lh build-output.tar.gz

    - name: ğŸ“¤ Upload compressed build to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        source: "build-output.tar.gz"
        target: ${{ secrets.DEPLOY_DIR }}
        overwrite: true

    - name: ğŸ“¦ Upload node_modules to nodevenv
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        source: "node_modules/*"
        target: ${{ secrets.NODE_MODULES_DIR }}
        overwrite: true
        strip_components: 0

    - name: âš™ï¸ Extract & Deploy on server
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        passphrase: ${{ secrets.SSH_PASSPHRASE }}
        script: |
          echo "ğŸš€ Starting deployment inside Node.js environment..."
          bash -lc '
            echo "ğŸ”§ Activating environment..."
            source ${{ secrets.NODE_ENV_PATH }}

            cd ${{ secrets.DEPLOY_DIR }}
            echo "ğŸ“¦ Extracting build-output.tar.gz..."
            tar -xzf build-output.tar.gz
            rm -f build-output.tar.gz

            echo "â™»ï¸ Restarting Node.js app..."
            mkdir -p tmp
            touch tmp/restart.txt || true

            echo "âœ… Deployment complete!"
          '