name: üöÄ Build Payload + Next.js for Manual Upload cPanel

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Detect Package Manager
        id: detect-pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi
          echo "Detected package manager: ${{ steps.detect-pm.outputs.manager }}"

      - name: Setup pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Dependencies
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      - name: Initialize Payload Database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          echo "üîß Ensuring migrations directory exists..."
          mkdir -p src/migrations
          echo "üîç Checking if 'posts' table exists..."
          node -e "
          import pg from 'pg';
          const client = new pg.Client(process.env.DATABASE_URL);
          const run = async () => {
            await client.connect();
            const res = await client.query(\`SELECT to_regclass('public.posts') as exists;\`);
            if (!res.rows[0].exists) {
              console.log('üß± No tables found, running payload migrate:fresh...');
              process.exit(1);
            } else {
              console.log('‚úÖ Tables exist, skipping init.');
              process.exit(0);
            }
          };
          run();
          " || (
            echo "y" | if [ '${{ steps.detect-pm.outputs.manager }}' = 'pnpm' ]; then
              pnpm payload migrate:fresh --force
            elif [ '${{ steps.detect-pm.outputs.manager }}' = 'yarn' ]; then
              yarn payload migrate:fresh --force
            else
              npx payload migrate:fresh --force
            fi
          )

      - name: Seed Default Admin User
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
        run: |
          echo "üå± Running admin seeder script with tsx..."
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm exec tsx src/utilities/admin-seed.ts
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn exec tsx src/utilities/admin-seed.ts
          else
            npx tsx src/utilities/admin-seed.ts
          fi

      - name: Build Next.js + Payload
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      - name: Prepare Files for Manual Upload
        run: |
          echo "üóÇÔ∏è Optimizing files for manual upload..."

          # Create deployment folders
          mkdir -p DEPLOY_STANDALONE
          mkdir -p DEPLOY_STATIC
          mkdir -p DEPLOY_PUBLIC

          # Copy optimized standalone files
          cp -r .next/standalone/* DEPLOY_STANDALONE/

          # Copy .next folder structure to standalone - FORCE COPY
          echo "üìÅ Copying .next folder structure..."
          mkdir -p DEPLOY_STANDALONE/.next
          if [ -d .next/static ]; then
            cp -r .next/static DEPLOY_STANDALONE/.next/
            echo "‚úÖ .next/static copied"
          fi
          if [ -f .next/build-manifest.json ]; then
            cp .next/build-manifest.json DEPLOY_STANDALONE/.next/
            echo "‚úÖ build-manifest.json copied"
          fi
          if [ -f .next/prerender-manifest.json ]; then
            cp .next/prerender-manifest.json DEPLOY_STANDALONE/.next/
            echo "‚úÖ prerender-manifest.json copied"
          fi
          if [ -f .next/route-manifest.json ]; then
            cp .next/route-manifest.json DEPLOY_STANDALONE/.next/
            echo "‚úÖ route-manifest.json copied"
          fi
          if [ -f .next/react-loadable-manifest.json ]; then
            cp .next/react-loadable-manifest.json DEPLOY_STANDALONE/.next/
            echo "‚úÖ react-loadable-manifest.json copied"
          fi
          if [ -d .next/server ]; then
            cp -r .next/server DEPLOY_STANDALONE/.next/
            echo "‚úÖ server folder copied"
          fi
          if [ -d .next/traces ]; then
            cp -r .next/traces DEPLOY_STANDALONE/.next/
            echo "‚úÖ traces folder copied"
          fi
          if [ -d .next/cache ]; then
            cp -r .next/cache DEPLOY_STANDALONE/.next/
            echo "‚úÖ cache folder copied"
          fi

          # Copy public files to standalone
          mkdir -p DEPLOY_STANDALONE/public
          cp -r public/* DEPLOY_STANDALONE/public/

          # Copy payload config and utilities
          mkdir -p DEPLOY_STANDALONE/src
          cp -r src/collections DEPLOY_STANDALONE/src/
          cp -r src/utilities DEPLOY_STANDALONE/src/
          cp -r src/plugins DEPLOY_STANDALONE/src/
          cp -r src/fields DEPLOY_STANDALONE/src/
          cp -r src/access DEPLOY_STANDALONE/src/
          cp -r src/hooks DEPLOY_STANDALONE/src/
          cp -r src/styles DEPLOY_STANDALONE/src/
          cp src/payload.config.ts DEPLOY_STANDALONE/src/

          # Copy static files for separate upload
          if [ -d .next/static ]; then
            cp -r .next/static/* DEPLOY_STATIC/
            echo "‚úÖ Static files copied to DEPLOY_STATIC"
          fi

          # Copy public files (only essential ones)
          cp public/*.{ico,svg,png,jpg,jpeg,gif,webp} DEPLOY_PUBLIC/ 2>/dev/null || true

          # Copy .htaccess - FORCE COPY with proper syntax
          echo "üìÑ Copying .htaccess file..."
          if [ -f .htaccess ]; then
            cp .htaccess DEPLOY_PUBLIC/
            cp .htaccess DEPLOY_STANDALONE/
            echo "‚úÖ .htaccess copied successfully"
          else
            echo "‚ùå .htaccess not found in root directory"
            # Create basic .htaccess if not exists - USE ECHO INSTEAD OF HEREDOC
            echo "# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN" > .htaccess
            echo "PassengerAppRoot \"/home/bungmek1/public_html/cms.bungmekanik.co.id\"" >> .htaccess
            echo "PassengerBaseURI \"/\"" >> .htaccess
            echo "PassengerNodejs \"/home/bungmek1/nodevenv/public_html/cms.bungmekanik.co.id/20/bin/node\"" >> .htaccess
            echo "PassengerAppType node" >> .htaccess
            echo "PassengerStartupFile server.js" >> .htaccess
            echo "PassengerNodeEnv production" >> .htaccess
            echo "PassengerStartupTimeout 120" >> .htaccess
            echo "PassengerMinInstances 1" >> .htaccess
            echo "PassengerMaxInstances 3" >> .htaccess
            echo "PassengerMaxRequestQueueSize 100" >> .htaccess
            echo "# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END" >> .htaccess
            cp .htaccess DEPLOY_PUBLIC/
            cp .htaccess DEPLOY_STANDALONE/
            echo "üìÑ Created basic .htaccess"
          fi

          # Remove unnecessary files
          find DEPLOY_STANDALONE -name "*.md" -delete
          find DEPLOY_STANDALONE -name "*.txt" -delete
          find DEPLOY_STANDALONE -name "*.log" -delete
          find DEPLOY_STANDALONE -name "README*" -delete
          find DEPLOY_STANDALONE -name ".git*" -delete
          find DEPLOY_STANDALONE -name "*.test.*" -delete
          find DEPLOY_STANDALONE -name "*.spec.*" -delete
          rm -rf DEPLOY_STANDALONE/tests 2>/dev/null || true
          rm -rf DEPLOY_STANDALONE/.git 2>/dev/null || true

          # Verify all folders and files
          echo "üîç Verifying all folders and files..."
          echo "üìÅ DEPLOY_STANDALONE contents:"
          ls -la DEPLOY_STANDALONE/
          echo "üìÅ .next folder in DEPLOY_STANDALONE:"
          if [ -d DEPLOY_STANDALONE/.next ]; then
            ls -la DEPLOY_STANDALONE/.next/
            echo "‚úÖ .next folder exists"
          else
            echo "‚ùå .next folder missing"
          fi
          echo "üìÅ Static folder in DEPLOY_STANDALONE/.next:"
          if [ -d DEPLOY_STANDALONE/.next/static ]; then
            ls -la DEPLOY_STANDALONE/.next/static/
            echo "‚úÖ Static folder exists"
          else
            echo "‚ùå Static folder missing"
          fi
          echo "üìÑ .htaccess in DEPLOY_STANDALONE:"
          if [ -f DEPLOY_STANDALONE/.htaccess ]; then
            ls -la DEPLOY_STANDALONE/.htaccess
            echo "‚úÖ .htaccess exists in DEPLOY_STANDALONE"
          else
            echo "‚ùå .htaccess missing in DEPLOY_STANDALONE"
          fi
          echo "üìÑ .htaccess in DEPLOY_PUBLIC:"
          if [ -f DEPLOY_PUBLIC/.htaccess ]; then
            ls -la DEPLOY_PUBLIC/.htaccess
            echo "‚úÖ .htaccess exists in DEPLOY_PUBLIC"
          else
            echo "‚ùå .htaccess missing in DEPLOY_PUBLIC"
          fi

          # Create upload instructions
          echo "MANUAL UPLOAD INSTRUCTIONS:" > UPLOAD_INSTRUCTIONS.txt
          echo "========================" >> UPLOAD_INSTRUCTIONS.txt
          echo "" >> UPLOAD_INSTRUCTIONS.txt
          echo "1. Connect via FileZilla to: ${{ secrets.CPANEL_FTP_SERVER }}" >> UPLOAD_INSTRUCTIONS.txt
          echo "2. Navigate to: /home/bungmek1/cms.bungmekanik.co.id/" >> UPLOAD_INSTRUCTIONS.txt
          echo "" >> UPLOAD_INSTRUCTIONS.txt
          echo "3. Upload DEPLOY_STANDALONE contents to root folder" >> UPLOAD_INSTRUCTIONS.txt
          echo "4. Upload DEPLOY_STATIC contents to _next/static/ folder" >> UPLOAD_INSTRUCTIONS.txt
          echo "5. Upload DEPLOY_PUBLIC contents to root folder" >> UPLOAD_INSTRUCTIONS.txt
          echo "6. Ensure .htaccess is in root folder" >> UPLOAD_INSTRUCTIONS.txt
          echo "" >> UPLOAD_INSTRUCTIONS.txt
          echo "Folder Structure:" >> UPLOAD_INSTRUCTIONS.txt
          echo "/cms.bungmekanik.co.id/" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îú‚îÄ‚îÄ [standalone files]" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îú‚îÄ‚îÄ .next/" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îÇ   ‚îú‚îÄ‚îÄ static/" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îÇ   ‚îú‚îÄ‚îÄ server/" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îÇ   ‚îî‚îÄ‚îÄ [other next files]" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îú‚îÄ‚îÄ _next/static/" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îÇ   ‚îî‚îÄ‚îÄ [static files]" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îú‚îÄ‚îÄ public/" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îÇ   ‚îî‚îÄ‚îÄ [public files]" >> UPLOAD_INSTRUCTIONS.txt
          echo "‚îî‚îÄ‚îÄ .htaccess" >> UPLOAD_INSTRUCTIONS.txt
          echo "" >> UPLOAD_INSTRUCTIONS.txt
          echo "After upload, access: https://cms.bungmekanik.co.id/admin" >> UPLOAD_INSTRUCTIONS.txt

          echo "‚úÖ Build optimization complete!"
          echo "üìÅ Ready for manual upload via FileZilla"
          echo "üìã See UPLOAD_INSTRUCTIONS.txt for details"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-files
          path: |
            DEPLOY_STANDALONE/
            DEPLOY_STATIC/
            DEPLOY_PUBLIC/
            UPLOAD_INSTRUCTIONS.txt
          retention-days: 1

      - name: Build Complete
        run: echo "‚úÖ Build selesai! Download artifacts dan upload manual via FileZilla"
