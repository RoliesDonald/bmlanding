name: ðŸš€ Build Payload + Next.js for Manual Upload cPanel

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ðŸ” Auto detect package manager
      - name: Detect Package Manager
        id: detect-pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi
          echo "Detected package manager: ${{ steps.detect-pm.outputs.manager }}"

      # âš™ï¸ Setup pnpm if needed
      - name: Setup pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # ðŸ“¦ Install dependencies
      - name: Install Dependencies
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      # ðŸ§± Initialize Payload DB schema (if not exists)
      - name: Initialize Payload Database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          echo "ðŸ”§ Ensuring migrations directory exists..."
          mkdir -p src/migrations
          echo "ðŸ” Checking if 'posts' table exists..."
          node -e "
          import pg from 'pg';
          const client = new pg.Client(process.env.DATABASE_URL);
          const run = async () => {
            await client.connect();
            const res = await client.query(\`SELECT to_regclass('public.posts') as exists;\`);
            if (!res.rows[0].exists) {
              console.log('ðŸ§± No tables found, running payload migrate:fresh...');
              process.exit(1);
            } else {
              console.log('âœ… Tables exist, skipping init.');
              process.exit(0);
            }
          };
          run();
          " || (
            echo "y" | if [ '${{ steps.detect-pm.outputs.manager }}' = 'pnpm' ]; then
              pnpm payload migrate:fresh --force
            elif [ '${{ steps.detect-pm.outputs.manager }}' = 'yarn' ]; then
              yarn payload migrate:fresh --force
            else
              npx payload migrate:fresh --force
            fi
          )

      # ðŸŒ± Auto Seed (create default admin if not exists)
      - name: Seed Default Admin User
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
        run: |
          echo "ðŸŒ± Running admin seeder script with tsx..."
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm exec tsx src/utilities/admin-seed.ts
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn exec tsx src/utilities/admin-seed.ts
          else
            npx tsx src/utilities/admin-seed.ts
          fi

      # ðŸ—ï¸ Build Next.js + Payload
      - name: Build Next.js + Payload
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      # ðŸ—‚ï¸ Optimize and prepare files for manual upload
      - name: Prepare Files for Manual Upload
        run: |
          echo "ðŸ—‚ï¸ Optimizing files for manual upload..."

          # Create deployment folders
          mkdir -p DEPLOY_STANDALONE
          mkdir -p DEPLOY_STATIC
          mkdir -p DEPLOY_PUBLIC

          # Copy optimized standalone files
          cp -r .next/standalone/* DEPLOY_STANDALONE/

          # Copy .next folder structure to standalone
          echo "ðŸ“ Copying .next folder structure..."
          mkdir -p DEPLOY_STANDALONE/.next
          cp -r .next/static DEPLOY_STANDALONE/.next/
          cp -r .next/build-manifest.json DEPLOY_STANDALONE/.next/ 2>/dev/null || true
          cp -r .next/prerender-manifest.json DEPLOY_STANDALONE/.next/ 2>/dev/null || true
          cp -r .next/route-manifest.json DEPLOY_STANDALONE/.next/ 2>/dev/null || true
          cp -r .next/react-loadable-manifest.json DEPLOY_STANDALONE/.next/ 2>/dev/null || true
          cp -r .next/server DEPLOY_STANDALONE/.next/ 2>/dev/null || true
          cp -r .next/traces DEPLOY_STANDALONE/.next/ 2>/dev/null || true
          cp -r .next/cache DEPLOY_STANDALONE/.next/ 2>/dev/null || true

          # Copy public files to standalone
          mkdir -p DEPLOY_STANDALONE/public
          cp -r public/* DEPLOY_STANDALONE/public/

          # Copy payload config and utilities
          mkdir -p DEPLOY_STANDALONE/src
          cp -r src/collections DEPLOY_STANDALONE/src/
          cp -r src/utilities DEPLOY_STANDALONE/src/
          cp -r src/plugins DEPLOY_STANDALONE/src/
          cp -r src/fields DEPLOY_STANDALONE/src/
          cp -r src/access DEPLOY_STANDALONE/src/
          cp -r src/hooks DEPLOY_STANDALONE/src/
          cp -r src/styles DEPLOY_STANDALONE/src/
          cp src/payload.config.ts DEPLOY_STANDALONE/src/

          # Copy static files for separate upload
          cp -r .next/static/* DEPLOY_STATIC/

          # Copy public files (only essential ones)
          cp public/*.{ico,svg,png,jpg,jpeg,gif,webp} DEPLOY_PUBLIC/ 2>/dev/null || true

          # Copy .htaccess - FORCE COPY
          echo "ðŸ“„ Copying .htaccess file..."
          if [ -f .htaccess ]; then
            cp .htaccess DEPLOY_PUBLIC/
            cp .htaccess DEPLOY_STANDALONE/
            echo "âœ… .htaccess copied successfully"
          else
            echo "âŒ .htaccess not found in root directory"
            # Create basic .htaccess if not exists
            cat > .htaccess << 'EOF'
# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION BEGIN
PassengerAppRoot "/home/bungmek1/public_html/cms.bungmekanik.co.id"
PassengerBaseURI "/"
PassengerNodejs "/home/bungmek1/nodevenv/public_html/cms.bungmekanik.co.id/20/bin/node"
PassengerAppType node
PassengerStartupFile server.js
PassengerNodeEnv production
PassengerStartupTimeout 120
PassengerMinInstances 1
PassengerMaxInstances 3
PassengerMaxRequestQueueSize 100
# DO NOT REMOVE. CLOUDLINUX PASSENGER CONFIGURATION END
EOF
            cp .htaccess DEPLOY_PUBLIC/
            cp .htaccess DEPLOY_STANDALONE/
            echo "ðŸ“„ Created basic .htaccess"
          fi

          # Remove unnecessary files
          find DEPLOY_STANDALONE -name "*.md" -delete
          find DEPLOY_STANDALONE -name "*.txt" -delete
          find DEPLOY_STANDALONE -name "*.log" -delete
          find DEPLOY_STANDALONE -name "README*" -delete
          find DEPLOY_STANDALONE -name ".git*" -delete
          find DEPLOY_STANDALONE -name "*.test.*" -delete
          find DEPLOY_STANDALONE -name "*.spec.*" -delete
          rm -rf DEPLOY_STANDALONE/tests 2>/dev/null || true
          rm -rf DEPLOY_STANDALONE/.git 2>/dev/null || true

          # Verify all folders and files
          echo "ðŸ” Verifying all folders and files..."
          echo "ðŸ“ DEPLOY_STANDALONE contents:"
          ls -la DEPLOY_STANDALONE/
          echo "ðŸ“ .next folder in DEPLOY_STANDALONE:"
          ls -la DEPLOY_STANDALONE/.next/ 2>/dev/null || echo "âŒ .next folder missing"
          echo "ðŸ“ Static folder in DEPLOY_STANDALONE/.next:"
          ls -la DEPLOY_STANDALONE/.next/static/ 2>/dev/null || echo "âŒ Static folder missing"
          echo "ðŸ“„ .htaccess in DEPLOY_STANDALONE:"
          ls -la DEPLOY_STANDALONE/.htaccess 2>/dev/null || echo "âŒ .htaccess missing in DEPLOY_STANDALONE"
          echo "ðŸ“„ .htaccess in DEPLOY_PUBLIC:"
          ls -la DEPLOY_PUBLIC/.htaccess 2>/dev/null || echo "âŒ .htaccess missing in DEPLOY_PUBLIC"

          # Create upload instructions
          cat > UPLOAD_INSTRUCTIONS.txt << 'EOF'
          MANUAL UPLOAD INSTRUCTIONS:
          ========================

          1. Connect via FileZilla to: ${{ secrets.CPANEL_FTP_SERVER }}
          2. Navigate to: /home/bungmek1/cms.bungmekanik.co.id/

          3. Upload DEPLOY_STANDALONE contents to root folder
          4. Upload DEPLOY_STATIC contents to _next/static/ folder
          5. Upload DEPLOY_PUBLIC contents to root folder
          6. Ensure .htaccess is in root folder

          Folder Structure:
          /cms.bungmekanik.co.id/
          â”œâ”€â”€ [standalone files]
          â”œâ”€â”€ .next/
          â”‚   â”œâ”€â”€ static/
          â”‚   â”œâ”€â”€ server/
          â”‚   â””â”€â”€ [other next files]
          â”œâ”€â”€ _next/static/
          â”‚   â””â”€â”€ [static files]
          â”œâ”€â”€ public/
          â”‚   â””â”€â”€ [public files]
          â””â”€â”€ .htaccess

          After upload, access: https://cms.bungmekanik.co.id/admin
          EOF

          echo "âœ… Build optimization complete!"
          echo "ðŸ“ Ready for manual upload via FileZilla"
          echo "ðŸ“‹ See UPLOAD_INSTRUCTIONS.txt for details"

      # ðŸ“¦ Upload artifacts for download
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-files
          path: |
            DEPLOY_STANDALONE/
            DEPLOY_STATIC/
            DEPLOY_PUBLIC/
            UPLOAD_INSTRUCTIONS.txt
          retention-days: 1

      - name: âœ… Build Complete
        run: echo "âœ… Build selesai! Download artifacts dan upload manual via FileZilla"
