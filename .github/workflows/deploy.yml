name: ðŸš€ Deploy Payload + Next.js Hybrid (Auto Init + Seed + FTP Upload)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ðŸ” Auto detect package manager
      - name: Detect Package Manager
        id: detect-pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi
          echo "Detected package manager: ${{ steps.detect-pm.outputs.manager }}"

      # âš™ï¸ Setup pnpm if needed
      - name: Setup pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # ðŸ“¦ Install dependencies
      - name: Install Dependencies
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      # ðŸ” Debug: List imports missing .ts extension
      - name: Debug List imports missing .ts extension
        run: |
          echo "ðŸ” Scanning for imports missing .ts extension..."
          # Mencari semua file .ts dan .tsx lalu mencari pola import yang bermasalah
          # Pola: import ... from './path' atau '@/path' yang TIDAK diakhiri .ts
          FOUND=$(find src -type f \( -name "*.ts" -o -name "*.tsx" \) -exec grep -Hn "from\s\+['\"]\(\.\.?\/\|@\/\)\(?!.*\.ts\)['\"]" {} \;)

          if [ -n "$FOUND" ]; then
            echo "âŒ ERROR : Found import missing the .ts extension"
            echo "------------------------------------------"
            echo "$FOUND"
            echo "------------------------------------------"
            echo "Please add the .ts extension to these import and commit the changes"
            exit 1
          else
            echo "âœ… No import missing the .ts extension"
          fi

      # ðŸ§± Initialize Payload DB schema (if not exists)
      - name: Initialize Payload Database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          echo "ðŸ” Checking if 'posts' table exists..."
          node -e "
          import pg from 'pg';
          const client = new pg.Client(process.env.DATABASE_URL);
          const run = async () => {
            await client.connect();
            const res = await client.query(\`SELECT to_regclass('public.posts') as exists;\`);
            if (!res.rows[0].exists) {
              console.log('ðŸ§± No tables found, running payload migrate:fresh...');
              process.exit(1);
            } else {
              console.log('âœ… Tables exist, skipping init.');
              process.exit(0);
            }
          };
          run();
          " || (
            if [ '${{ steps.detect-pm.outputs.manager }}' = 'pnpm' ]; then
              pnpm payload migrate:fresh --force --yes
            elif [ '${{ steps.detect-pm.outputs.manager }}' = 'yarn' ]; then
              yarn payload migrate:fresh --force --yes
            else
              npx payload migrate:fresh --force --yes
            fi
          )

      # ðŸŒ± Auto Seed (create default admin if not exists)
      - name: Seed Default Admin User
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
        run: |
          echo "ðŸŒ± Compiling seeder script and dependencies..."
          # Buat file tsconfig sementara khusus untuk kompilasi seeder
          cat > tsconfig.seeder.json << EOF
          {
            "extends": "./tsconfig.json",
            "compilerOptions": {
              "outDir": "./dist-seeder",
              "module": "ESNext",
              "target": "ES2022",
              "moduleResolution": "Node"
            },
            "include": [
              "src/utilities/admin-seed.ts",
              "src/payload.config.ts",
              "src/collections/**/*.ts",
              "src/fields/**/*.ts"
            ]
          }
          EOF

          echo "ðŸ”§ Running: npx tsc --project tsconfig.seeder.json"
          npx tsc --project tsconfig.seeder.json

          echo "ðŸŒ± Running compiled seeder script with Node.js..."
          # Jalankan file .js hasil kompilasi dengan node murni
          # Tidak ada lagi ts-node, loader, atau require yang rumit
          node ./dist-seeder/utilities/admin-seed.js

      # ðŸ—ï¸ Build Next.js + Payload
      - name: Build Next.js + Payload
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      # ðŸ§³ Prepare deployment package
      - name: Prepare Deployment Package
        run: |
          zip -r build.zip . -x "*.git*" "node_modules/*" ".github/*"

      # ðŸ“¤ Deploy to cPanel via FTP
      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: .
          server-dir: /cms.bungmekanik.co.id/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/payload-types.ts
            **/build.zip

      - name: âœ… Done ya
        run: echo "âœ… Build + Seed + Deploy selesai! Akses admin di/admin"
