name: üöÄ Deploy Payload + Next.js Hybrid

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # üîç Auto detect package manager
      - name: Detect Package Manager
        id: detect-pm
        run: |
          if [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi
          echo "Detected package manager: ${{ steps.detect-pm.outputs.manager }}"

      # ‚öôÔ∏è Setup pnpm if needed
      - name: Setup pnpm
        if: steps.detect-pm.outputs.manager == 'pnpm'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      # üì¶ Install dependencies
      - name: Install Dependencies
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      # üß± Initialize Payload DB schema (if not exists)
      - name: Initialize Payload Database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          echo "üîß Ensuring migrations directory exists..."
          mkdir -p src/migrations
          echo "üîç Checking if 'posts' table exists..."
          node -e "
          import pg from 'pg';
          const client = new pg.Client(process.env.DATABASE_URL);
          const run = async () => {
            await client.connect();
            const res = await client.query(\`SELECT to_regclass('public.posts') as exists;\`);
            if (!res.rows[0].exists) {
              console.log('üß± No tables found, running payload migrate:fresh...');
              process.exit(1);
            } else {
              console.log('‚úÖ Tables exist, skipping init.');
              process.exit(0);
            }
          };
          run();
          " || (
            echo "y" | if [ '${{ steps.detect-pm.outputs.manager }}' = 'pnpm' ]; then
              pnpm payload migrate:fresh --force
            elif [ '${{ steps.detect-pm.outputs.manager }}' = 'yarn' ]; then
              yarn payload migrate:fresh --force
            else
              npx payload migrate:fresh --force
            fi
          )

      # üå± Auto Seed (create default admin if not exists)
      - name: Seed Default Admin User
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
        run: |
          echo "üå± Running admin seeder script with tsx..."
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm exec tsx src/utilities/admin-seed.ts
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn exec tsx src/utilities/admin-seed.ts
          else
            npx tsx src/utilities/admin-seed.ts
          fi

      # üèóÔ∏è Build Next.js + Payload
      - name: Build Next.js + Payload
        env:
          DATABASE_URL: ${{ secrets.DATABASE_BUILD_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          PAYLOAD_CONFIG_PATH: src/payload.config.ts
        run: |
          if [ "${{ steps.detect-pm.outputs.manager }}" = "pnpm" ]; then
            pnpm run build
          elif [ "${{ steps.detect-pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build
          fi

      # üóÇÔ∏è Optimize deployment size
      - name: Optimize deployment files
        run: |
          echo "üóÇÔ∏è Optimizing deployment size..."
          # Remove unnecessary files from standalone build
          find .next/standalone -name "*.md" -delete
          find .next/standalone -name "*.txt" -delete
          find .next/standalone -name "*.log" -delete
          find .next/standalone -name "README*" -delete
          find .next/standalone -name ".git*" -delete
          # Remove test files and development files
          find .next/standalone -name "*.test.*" -delete
          find .next/standalone -name "*.spec.*" -delete
          # Remove development-only directories if they exist
          rm -rf .next/standalone/tests 2>/dev/null || true
          rm -rf .next/standalone/.git 2>/dev/null || true
          echo "‚úÖ Deployment optimization complete"

      # üì§ Final Deploy using LFTP (Most Reliable)
      - name: Deploy to cPanel using LFTP
        run: |
          # Install LFTP
          sudo apt-get update && sudo apt-get install -y lftp

          # Create LFTP script with robust settings
          cat << 'EOF' > deploy_script.lftp
          set ftp:ssl-allow no
          set ftp:passive-mode on
          set ftp:list-options -a
          set net:max-retries 3
          set net:timeout 120
          set net:reconnect-interval 30
          set net:connection-limit 1
          set xfer:clobber on
          set mirror:use-pget-n 1
          set mirror:parallel-transfer-count 1
          set ssl:verify-certificate no

          # Connect to FTP server
          open ftp://${{ secrets.CPANEL_FTP_USERNAME }}:${{ secrets.CPANEL_FTP_PASSWORD }}@${{ secrets.CPANEL_FTP_SERVER }}

          # Create directories first
          mkdir -f cms.bungmekanik.co.id
          mkdir -f cms.bungmekanik.co.id/_next
          mkdir -f cms.bungmekanik.co.id/_next/static

          # Upload standalone application (single thread for stability)
          echo "üì§ Uploading standalone application..."
          mirror --reverse --verbose --ignore-time --no-perms --parallel=1 .next/standalone/ cms.bungmekanik.co.id/

          # Upload static assets
          echo "üì§ Uploading static assets..."
          mirror --reverse --verbose --ignore-time --no-perms --parallel=1 .next/static/ cms.bungmekanik.co.id/_next/static/

          # Upload public files
          echo "üì§ Uploading public files..."
          mirror --reverse --verbose --ignore-time --no-perms --parallel=1 --exclude-glob="*.log" --exclude-glob="*.tmp" --exclude-glob="cache/" --exclude-glob="src/" --exclude-glob="components/" public/ cms.bungmekanik.co.id/

          # Upload .htaccess
          echo "üì§ Uploading .htaccess..."
          put .htaccess cms.bungmekanik.co.id/.htaccess

          quit
          EOF

          # Execute deployment with retry
          for i in {1..3}; do
            echo "üöÄ Deployment attempt $i of 3..."
            if lftp -f deploy_script.lftp; then
              echo "‚úÖ Deployment successful!"
              break
            else
              echo "‚ùå Deployment attempt $i failed. Retrying in 30 seconds..."
              sleep 30
            fi
          done

          echo "‚úÖ LFTP deployment completed!"

      - name: ‚úÖ Done ya
        run: echo "‚úÖ Build + Deploy selesai! Akses admin di/admin"
