name: üöÄ Deploy Payload + Next.js Hybrid to CPanel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: üèóÔ∏è Build Next.js + Payload CMS
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          PAYLOAD_PUBLIC_URL: ${{ secrets.PAYLOAD_PUBLIC_URL }}
          PAYLOAD_SKIP_DB: 'true'
        run: npm run build -- --no-lint

      # Upload hasil build Next.js (static/export) ke public_html
      - name: üöö Deploy to Dewaweb via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: ./out
          server-dir: /public_html/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/payload-types.ts
            **/build.zip

      # (Opsional) Simpan build.zip untuk backup di cPanel
      - name: üß≥ Upload zipped build (optional)
        run: |
          zip -r build.zip . -x "*.git*" "node_modules/*" ".github/*"

      - name: üì§ Upload build.zip to cPanel via FTP (optional)
        if: success()
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.CPANEL_FTP_SERVER }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: .
          server-dir: /cms.bungmekanik.co.id/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
            **/payload-types.ts

      - name: üîÑ Notify (manual restart)
        run: echo "‚úÖ Upload complete. Please restart Node.js app in cPanel manually."
